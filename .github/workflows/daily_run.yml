name: Daily Clipagem Run

on:
  schedule:
    - cron: '0 9 * * *'  # 09:00 UTC = 06:00 BRT (Brasilia)
  workflow_dispatch:

permissions:
  contents: write # Permiss√£o para criar commits e push

jobs:
  clipagem-automation:
    runs-on: ubuntu-latest
    
    steps:
      # ==================== CHECKOUT ====================
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==================== SETUP PYTHON ====================
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # ==================== INSTALAR DEPEND√äNCIAS ====================
      - name: üì¶ Instalar depend√™ncias
        run: |
          echo "[INFO] Atualizando pip..."
          python -m pip install --upgrade pip
          
          echo "[INFO] Instalando requirements.txt..."
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "[WARN] requirements.txt n√£o encontrado, instalando manualmente..."
            pip install selenium webdriver-manager google-generativeai pymupdf streamlit
          fi
          
          echo "[INFO] Verificando instala√ß√µes..."
          python -c "import selenium; print(f'‚úì selenium: {selenium.__version__}')"
          python -c "import google.generativeai; print('‚úì google.generativeai')"
          python -c "import fitz; print('‚úì pymupdf')"
          python -c "import streamlit; print('‚úì streamlit')"

      # ==================== INSTALAR CHROME ====================
      - name: üåê Instalar Google Chrome
        run: |
          echo "[INFO] Atualizando lista de pacotes..."
          sudo apt-get update
          
          echo "[INFO] Instalando Google Chrome..."
          if ! sudo apt-get install -y google-chrome-stable; then
            echo "[WARN] apt-get falhou, tentando instalar via .deb..."
            wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -O /tmp/google-chrome.deb
            sudo apt-get install -y /tmp/google-chrome.deb
          fi
          
          echo "[INFO] Verificando instala√ß√£o..."
          google-chrome --version
          which google-chrome

      # ==================== EXECUTAR DAILY SCRAPER ====================
      - name: ü§ñ Executar Daily Scraper
        env:
          DIARIO_LOGIN_URL: ${{ secrets.DIARIO_LOGIN_URL }}
          DIARIO_ACCESS_URL: ${{ secrets.DIARIO_ACCESS_URL }}
          DIARIO_USER: ${{ secrets.DIARIO_USER }}
          DIARIO_PASS: ${{ secrets.DIARIO_PASS }}
        run: |
          echo "[RUN] Iniciando daily_scraper.py..."
          python src/daily_scraper.py
          
          echo "[RUN] Verificando sa√≠da..."
          ls -lh data/
          
          if [ -f data/diario_sm_atual.pdf ]; then
            echo "‚úì PDF baixado com sucesso!"
            file data/diario_sm_atual.pdf
          else
            echo "‚úó ERRO: PDF n√£o foi encontrado ap√≥s execu√ß√£o"
            exit 1
          fi

      # ==================== EXECUTAR ANALYZER ====================
      - name: üß† Executar Gemini Analyzer
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "[RUN] Iniciando analyzer.py..."
          python src/analyzer.py
          
          echo "[RUN] Verificando sa√≠da..."
          ls -lh data/
          
          if [ -f data/clipagem_hoje.json ]; then
            echo "‚úì JSON de clipagem gerado com sucesso!"
            head -50 data/clipagem_hoje.json
          else
            echo "‚úó ERRO: JSON n√£o foi encontrado ap√≥s execu√ß√£o"
            exit 1
          fi

      # ==================== AUTO-COMMIT ====================
      - name: üìù Auto-Commit de Dados Alterados
        run: |
          echo "[COMMIT] Configurando Git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "[COMMIT] Sincronizando com origin/main..."
          git pull --rebase origin main

          echo "[COMMIT] Verificando status..."
          git status
          
          echo "[COMMIT] Adicionando arquivos de data/..."
          git add -A data/
          
          echo "[COMMIT] Verificando diff..."
          git diff --cached --stat
          
          if [ -n "$(git diff --cached --name-only)" ]; then
            echo "[COMMIT] Criando commit..."
            git commit -m "üîÑ Auto-update: Clipagem e PDF do Di√°rio de SM" \
              -m "- PDF: Edi√ß√£o de $(date '+%d/%m/%Y')" \
              -m "- An√°lise: Processada com Google Gemini 2.0 Flash" \
              -m "- Timestamp: $(date '+%Y-%m-%d %H:%M:%S')" \
              -m "[skip ci]" || true
            
            echo "[COMMIT] Fazendo push..."
            git push origin HEAD:main
            
            echo "‚úì Dados commitados e atualizados com sucesso!"
          else
            echo "[COMMIT] Nenhuma mudan√ßa detectada, skipping commit..."
          fi

      # ==================== NOTIFICA√á√ÉO DE SUCESSO ====================
      - name: ‚úÖ Notifica√ß√£o de Sucesso
        run: |
          echo "=========================================="
          echo "‚úì EXECU√á√ÉO COMPLETADA COM SUCESSO"
          echo "=========================================="
          echo ""
          echo "Arquivos gerados:"
          ls -lh data/ 2>/dev/null || echo "Pasta data/ n√£o encontrada"
          echo ""
          echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Timezone: $(date '+%Z')"

      # ==================== NOTIFICA√á√ÉO DE ERRO ====================
      - name: ‚ùå Notifica√ß√£o de Erro
        if: failure()
        run: |
          echo "=========================================="
          echo "‚úó ERRO NA EXECU√á√ÉO DO WORKFLOW"
          echo "=========================================="
          echo ""
          echo "Verifique os logs acima para mais detalhes."
          echo "GitHub Actions URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
